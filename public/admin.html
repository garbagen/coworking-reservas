<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel de Gestión - Reservas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* Estilos para botones y mensajes */
    .btn {
      margin: 0 2px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>Gestión de Reservas</h1>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Spot</th>
          <th>Fecha</th>
          <th>Turno</th>
          <th>Usuario</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="reservationsTable">
        <!-- Las reservas se cargarán aquí -->
      </tbody>
    </table>
  </div>
  
  <script>
    // Solicitar credenciales de admin (se solicitan al cargar la página)
    const username = prompt("Introduce el usuario admin:").trim();
    const password = prompt("Introduce la contraseña admin:").trim();
    
    // Prepara el header de autorización
    const authHeader = "Basic " + btoa(username + ":" + password);
    
    // Función para cargar reservas y mostrarlas en la tabla
    function loadReservations() {
      fetch('/admin/reservations', { headers: { "Authorization": authHeader } })
        .then(response => {
          if (!response.ok) {
            throw new Error("Error de autenticación o problema en la solicitud");
          }
          return response.json();
        })
        .then(data => {
          const tableBody = document.getElementById("reservationsTable");
          tableBody.innerHTML = ""; // Limpiar tabla
          data.forEach(reservation => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${reservation._id}</td>
              <td>${reservation.spaceId}</td>
              <td>${new Date(reservation.date).toLocaleDateString()}</td>
              <td>${reservation.turn}</td>
              <td>${reservation.user}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="editReservation('${reservation._id}')">Editar</button>
                <button class="btn btn-sm btn-danger" onclick="deleteReservation('${reservation._id}')">Borrar</button>
              </td>
            `;
            tableBody.appendChild(tr);
          });
        })
        .catch(error => alert("Error al obtener las reservas: " + error.message));
    }
    
    // Llamada inicial para cargar reservas
    loadReservations();
    
    // Función para borrar una reserva
    function deleteReservation(id) {
      if (!confirm("¿Estás seguro de que deseas borrar esta reserva?")) return;
      
      fetch(`/api/reservations/${id}`, {
        method: 'DELETE',
        headers: { "Authorization": authHeader }
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || "Reserva borrada");
        loadReservations(); // Recargar la lista
      })
      .catch(error => alert("Error al borrar la reserva: " + error.message));
    }
    
    // Función para editar una reserva
    function editReservation(id) {
      // Se solicitan nuevos valores mediante prompt; en una app real usarías un formulario o modal.
      const newSpaceId = prompt("Nuevo Spot (1-6):");
      const newDate = prompt("Nueva Fecha (YYYY-MM-DD):");
      const newTurn = prompt("Nuevo Turno (mañana/tarde):");
      const newUser = prompt("Nuevo Usuario:");
      
      // Construir objeto de actualización; solo se envían los campos que el usuario complete.
      const updateData = {};
      if (newSpaceId) updateData.spaceId = newSpaceId;
      if (newDate) updateData.date = newDate;
      if (newTurn) updateData.turn = newTurn;
      if (newUser) updateData.user = newUser;
      
      fetch(`/api/reservations/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          "Authorization": authHeader
        },
        body: JSON.stringify(updateData)
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || "Reserva actualizada");
        loadReservations(); // Recargar la lista
      })
      .catch(error => alert("Error al editar la reserva: " + error.message));
    }
  </script>
</body>
</html>
